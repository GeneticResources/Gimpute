
---
title: "Gimpute: An efficient genetic data imputation pipeline"
author:
 - name: Junfang Chen, Dietmar Lippold and Emanuel Schwarz
   affiliation: Central Institute of Mental Health, Heidelberg University, Germany  
date: 17 June 2018 
output: BiocStyle::html_document 
vignette: >
   %\VignetteIndexEntry{Gimpute tutorial}
   %\VignetteEngine{knitr::rmarkdown}
   %\VignetteEncoding{UTF-8}
---

```{r style, echo = FALSE, results = 'asis'}
BiocStyle::markdown()
```

```{r global_options, include=FALSE}  
knitr::opts_chunk$set(message=FALSE, error=FALSE, warning=FALSE, fig.width=10, fig.height=7)
options(width=80) 
```
 


# About Gimpute
## Background
Genome-wide association studies (GWAS) have become an essential tool in assisting the improvement of understanding of neuropathology of diseases. Moreover, the imputation of genotyping data with missing information can enhance the power of GWAS by using haplotype relationships between genetic variants. In the meantime, the imputation can substantially reduce the cost of genotyping large number of samples. Furthermore, the comparison of significant findings across different cohorts and genotyping platforms is also achievable. Currently large amounts of genotyping data are produced at an unprecedented rate to be analyzed; however, the preparation of ready-to-use data sets needs to be of high quality. Thus the implementation of an efficient and reliable genetic data pre-processing and imputation pipeline is desirable.

## Scope of the pipeline 
In order to ensure the reliability and reproducibility of genome-wide association study (GWAS) data, 
we set up an efficient, automatic and comprehensive genotype data processing and imputation pipeline termed __Gimpute__.
It consists of pre-processing (genetic variant information updating/matching/liftOver,
quality control of genetic variants and study samples, the alignment of variants to the imputation references), 
imputation and post-imputation quality control, as well as an extension to the Genipe framework in this vignette, which is easy-to-follow and user-friendly. 


# Getting started  
## Prerequisites
Gimpute runs on any 64-bit x86 Linux distribution and it requires the following tools:

* [R](https://www.r-project.org/) 
* [PLINK](https://www.cog-genomics.org/plink2) 
* [GCTA64](http://cnsgenomics.com/software/gcta/#Download) 
* [SHAPEIT](http://www.shapeit.fr/) 
* [IMPUTE2](https://mathgen.stats.ox.ac.uk/impute/impute_v2.html) 
* [GTOOL](http://www.well.ox.ac.uk/~cfreeman/software/gwas/gtool.html) 

## Installation 
Development version from Github:
```{r eval=FALSE}
install.packages("devtools")
library("devtools")
install_github("transbioZI/Gimpute")
```
This function`install_github()` requires that you build from source, 
namely, `make` and compilers must be installed on the system.
 
## Experimental data
PLINK format files (PED/MAP or BED/BIM/FAM) are required as the input genotyping data for our pipeline. 
Free datasets are available under ./extdata/ in our package. The way for loading these PLINK binary files is shown as below. Since sharing of genetic genotyping data is strictly prohibited, we did not upload any private genotyping data for this demonstration. However you can either use your own genotyping data or download the data set through dbGaP via [dbGaP authorized access system](https://dbgap.ncbi.nlm.nih.gov/aa/wga.cgi?page=login). 

```{r eval=FALSE} 
library(Gimpute)
## Load PLINK binary files from Gimpute package
bedFile <- system.file("extdata", "study.bed", package="Gimpute")
bimFile <- system.file("extdata", "study.bim", package="Gimpute") 
famFile <- system.file("extdata", "study.fam", package="Gimpute") 
```

## Get it Setup 
### File and directory naming conventions
The files processed and generated are named in a consistent way across all datasets as follows:

* filename.# represents a set of the three PLINK files, i.e. the .bed, .fam and .bim file. 
Binary PLINK files are recommended due to their smaller file size and fast processing.

* filename.txt denotes a file with additional information, such as metadata information, SNP names, in pure text format.
The names of the output files begin with the number of the step which produces the respective file.

* Directory naming:
```{r eval=FALSE} 
## Start an R session in a directory where you'd like to generate the data.
system("mkdir 0-rawData")
system("mkdir 1-conversion")
system("mkdir 2-QC")
system("mkdir 3-lifting")
system("mkdir 4-imputation")
system("mkdir 5-reductAndExpand")
system("mkdir 6-finalResults")

## Go to ./0-rawData, where you want to place the original data.
setwd("0-rawData")
system("mkdir plinkFiles") ## Original PLINK data 
system("mkdir sampleInfo") ## Metadata 
setwd("..")
```


### Configuration files
* Imputation reference files

Publicly avaiable reference datasets can be downloaded from [IMPUTE2's reference page](https://mathgen.stats.ox.ac.uk/impute/impute_v2.html#reference), such as haplotypes from [1000 genome project](https://mathgen.stats.ox.ac.uk/impute/ALL_1000G_phase1integrated_v3_impute_macGT1.tgz). 

```{r eval=FALSE} 
## Define the directory where you place the imputation reference files 
impRefDIR <- "/home/junfang.chen/Gimpute/imputeRef/1000Gphase1/"
```  

* Genotyping chip annotation file 
Most of common chip annotation files can be directly downloaded from [Dr. William Rayner'page](http://www.well.ox.ac.uk/~wrayner/strand/). 
These files are particularly important for strand checking and genomic information of genotypes on a variety of genome builds.
```{r eval=FALSE} 
## chipAnnoFile <- "/home/junfang.chen/Gimpute/config/Illumina/Human1M-Duov3_B-b37.Illmn.strand"
chipAnnoFile <- NULL 
``` 
* Self-defined configuration files
```{r eval=FALSE} 
## if it's not NULL, then the file stores the duplicated sample IDs 
## should be placed in this directory.
dupSampleIDFile <- NULL 
## if it's not NULL, then the file stores the probes 
## which have to be excluded should be placed in this directory.
excludedProbeIdsFile <- NULL 
```
  
### Required tools

```{r eval=FALSE} 
## Define required tools
plink <- "/home/junfang.chen/Gimpute/tools/plink"
gcta <- "/home/junfang.chen/Gimpute/tools/gcta64" 
shapeit <- "/home/junfang.chen/Gimpute/tools/shapeit"
impute2 <- "/home/junfang.chen/Gimpute/tools/impute2"
gtool <- "/home/junfang.chen/Gimpute/tools/gtool"
```

# Running pipeline 
## Genotyping data conversion

All files named in this subsection are in the directory 1-conversion/.

### Input files

* Raw genotype data in PLINK format: ../0-rawData/plinkFiles/*.#

* Meta-data information file about the instances: ../0-rawData/sampleInfo/*.txt

* Chip annotation file for genotype information mapping and strand check (see section 2.4.2).

* The file with the IDs of the excluded instances (see section 2.4.2).

* The file with the IDs of the excluded probes of the chip (see section 2.4.2).


### Individual processing steps

0. Locate the original PLINK files and metadata information either from our package or your side.

```{r eval=FALSE} 
## Load PLINK binary files and metadata information from Gimpute package
bedFile <- system.file("extdata", "study.bed", package="Gimpute")
bimFile <- system.file("extdata", "study.bim", package="Gimpute") 
famFile <- system.file("extdata", "study.fam", package="Gimpute")
metadataFile <- system.file("extdata", "1_01_metaData.txt", package="Gimpute")

## Copy into the "0-rawData" directory
system(paste0("scp ", bedFile, " ./0-rawData/plinkFiles/")) 
system(paste0("scp ", bimFile, " ./0-rawData/plinkFiles/")) 
system(paste0("scp ", famFile, " ./0-rawData/plinkFiles/")) 
system(paste0("scp ", metadataFile, " ./0-rawData/sampleInfo/"))  
```

1. Use the raw genotype data and metadata information file to generate a file with the following content (column names are in parentheses): family ID in the PLINK files (FID), individual ID in the PLINK files (IID), ID in the description files (descID), self identified ancestry (ance; e.g. EA or AA), sex (sex; 1 = male, 2 = female), age (age), group (group; 0 = control/unaffected, 1 = case/affected). All unknown and missing values are represented by the value NA. Lines with a missing value for FID or IID are not contained. In the following example, the metadata file is already preprocessed.
+ Output file: 1_01_metaData.txt 

```{r eval=FALSE} 
## Load PLINK binary files and meta information file
system( paste0("scp ./0-rawData/plinkFiles/study.*  ./1-conversion/") ) 
system( paste0("scp ./0-rawData/sampleInfo/1_01_metaData.txt ./1-conversion/") ) 
setwd("./1-conversion/") 
```

2. Remove all excluded instances from the raw chip data.
+ Output files: 1_02_removedExclInst.#
```{r eval=FALSE} 
dupSampleIDFile <- NULL
inputPrefix <- "study" ## from last step
outputPrefix <- "1_02_removedExclInst" 
removeDupID(plink, dupSampleIDFile, inputPrefix, outputPrefix)
```
3. Replace all values for affection (phenotype, group) and sex in the PLINK fam file by those values in the file 1_01_metaData.txt. In regards to this, the missing value for sex is represented by the value 0 (zero), the missing value for affection (group) is represented by the value -9.
+ Output files: 1_03_replacedGroupAndSex.#
```{r eval=FALSE} 
metaDataFile <- "1_01_metaData.txt"
inputPrefix <- "1_02_removedExclInst"
outputPrefix <- "1_03_replacedGroupAndSex"
replaceGroupId(plink, inputPrefix, metaDataFile, outputPrefix)
```
4. Remove instances which have the missing affection value (i.e. the value -9).
+ Output files: 1_04_removedNoGroupId.#
```{r eval=FALSE} 
metaDataFile <- "1_01_metaData.txt"
inputPrefix <- "1_03_replacedGroupAndSex"
outputPrefix <- "1_04_removedNoGroupId"
removeNoGroupId(plink, inputPrefix, outputPrefix)
```
5. Remove instances which have a value for ance (self identified ancestry) in the file 1_01_metaData.txt that is excluded from the dataset (for the excluded ancestry values see section 2.4.2).
+ Output files: 1_05_removedWrongAnceInst.#
```{r eval=FALSE} 
ancestrySymbol <- "EA"
metaDataFile <- "1_01_metaData.txt" 
inputPrefix <- "1_04_removedNoGroupId"
outputPrefix <- "1_05_removedWrongAnceInst"
removedWrongAnceInst(plink, inputPrefix, metaDataFile, ancestrySymbol, outputPrefix)
```
6. Remove the excluded probes of the chip and check to see there are not two probes with the same name afterwards (if there is a name which is contained twice, then no output file is generated).
+ Output files: 1_06_removedExclProbe.#
```{r eval=FALSE} 
inputPrefix <- "1_05_removedWrongAnceInst"
excludedProbeIdsFile <- excludedProbeIdsFile   
outputPrefix <- "1_06_removedExclProbe"  
removedExclProbe(plink, inputPrefix, excludedProbeIdsFile, outputPrefix) 
```
7. Remove probes which are not contained in the annotation file or which have missing values in the annotation file.
+ Primary output files: 1_07_removedUnmapProbes.#
+ Output file with the removed probes:1_07_probesUnmapped2ChipRef.txt
```{r eval=FALSE} 
inputPrefix <- "1_06_removedExclProbe"
chipAnnoFile <- chipAnnoFile  
chipType <- 'illumina'
outputPrefix <- "1_07_removedUnmapProbes"   
outputSNPunmapFile <- "1_07_probesUnmapped2ChipRef.txt"
removedUnmapProbes(plink, inputPrefix, chipAnnoFile, outputPrefix, outputSNPunmapFile)
```
8. Remove probes which belong to a SNP or have a position (i.e. a base pair position and chromosome) in the annotation file which is the same as that of at least one other probe.
+ Primary output files: 1_08_removedDoubleProbes.#
+ Output file with the removed probes:1_08_probesDouble.txt
```{r eval=FALSE} 
inputPrefix <- "1_07_removedUnmapProbes" 
chipAnnoFile <- chipAnnoFile  
chipType <- 'illumina'
outputSNPdupFile <- "1_08_probesDouble.txt"
outputPrefix <- "1_08_removedDoubleProbes"   
removedDoubleProbes(plink, inputPrefix, chipAnnoFile, chipType, outputSNPdupFile, outputPrefix)
```
9. Use the annotation file to replace the probe names by SNP names, in order to update the SNP chromosomal location and the SNP base pair position, as well as to convert all alleles to the positive strand. For that use the following mapping form chromosome names to numbers: X ! 23, Y !24, XY (pseudo-autosomal region of X) ! 25, MT (mitochondrial) !26.
+ Output files: 1_09_updatedSnpInfo.#

```{r eval=FALSE} 
inputPrefix <- "1_08_removedDoubleProbes" 
chipAnnoFile <- chipAnnoFile  
chipType <- 'illumina'

outputPrefix <- "1_09_updatedSnpInfo"   
updatedSnpInfo(plink, inputPrefix,  chipAnnoFile, chipType, outputPrefix)
```
10. Correct the chromosome of the SNPs in the pseudoautosomal region by using the plink option --split-x with the name of the genome build of the annotation file.
+ Output files: 1_10_changedXyChr.#

```{r eval=FALSE} 
inputPrefix <- "1_09_updatedSnpInfo"
outputPrefix <- "1_10_changedXyChr"
changedXyChr(plink, inputPrefix, outputPrefix)
```
11. Remove the SNPs of the chromosomes 24 (Y) and 26 (MT).
+ Output files: 1_11_removedYMtSnp.#

```{r eval=FALSE} 
inputPrefix <- "1_10_changedXyChr"
outputPrefix <- "1_11_removedYMtSnp"
removedYMtSnp(plink, inputPrefix, outputPrefix)
```


### Running 

```{r eval=FALSE} 
## module function
inputPrefix <- "study"
outputPrefix <- "1_11_removedYMtSnp" 
metaDataFile <- "1_01_metaData.txt"
updateGenoInfo(plink, inputPrefix, metaDataFile, dupSampleIDFile,
			   ancestrySymbol, excludedProbeIdsFile, chipAnnoFile,
			   chipType, outputPrefix)
```



```{r eval=FALSE} 
## remove unwanted files
system( paste0("rm  *.log") ) 
## change dir to the main directory
setwd("..")   
```




## Quality control

All files named in this subsection are in the directory 2-QC/.

Input files:

* Genotype data after converting to the targeted genome build:../1-conversion/1_11_removedYMtSnp.#

Processing steps:

1. Determine for each SNP of the chromosome 23 from the genotype data the number of male instances which have the value one as the minor allele count for that SNP. Then, remove all SNPs which number is higher than 0.5 % of the number of male instances. Note that 0.5% is just an example, this should be dataset specific.
+ Primary output files: 2_01_removedSnpHetX.#
+ Output file with the number of instances with heterozygous alleles for each SNP of the chromosome 23 before SNP removal (each line contains a SNP name and the respective number, lines are sorted descending by number): 2_01_snpHHfreqAll.txt
+ Output file with the number of instances with heterozygous alleles for each SNP of the chromosome 23 after SNP removal:2_01_snpHHfreqRetained.txt
```{r eval=FALSE} 
## copy the last output plink files from 1-conversion
inputPrefix4QC <- "1_11_removedYMtSnp"
system( paste0("scp ./1-conversion/", inputPrefix4QC, ".*", " ./2-QC/") )
setwd("./2-QC/")

## step 1 
inputPrefix <- inputPrefix4QC
hhCutOff <- 0.005   
outputPrefix <- "2_01_removedSnpHetX" 
outputFile_SNPhhFreqAll <- "2_01_snpHHfreqAll.txt"
outputFile_SNPhhFreqRetained <- "2_01_snpHHfreqRetained.txt"
removedSnpHetX(plink, inputPrefix, hhCutOff, outputPrefix, outputFile_SNPhhFreqAll, outputFile_SNPhhFreqRetained)
```
2. Determine for each male instance the number of SNPs of the chromosome 23 which have the value one as the minor allele count for that instance. Next, remove all instances which number is higher than 15. Note that 15 is just an example, this should be dataset specific.
+ Primary output files: 2_02_removedInstHetX.#
+ Output file stores male subjects that have heterozygous SNPs with their frequency (if any): 2_02_instHetXfreqAll.txt
+ Output file stores male subjects that have heterozygous SNPs with their frequency after 'improper' subject removal (if any):2_02_instHetXfreqRetained.txt
+ Output file stores all heterozygous SNPs with their frequency (the number of males for this SNP): 2_02_snpHHfreqAll.txt

```{r eval=FALSE} 
inputPrefix <- "2_01_removedSnpHetX"
hhSubjCutOff <- 15
outputPrefix <- "2_02_removedInstHetX"
outputFile_subjHetFreqAll <- "2_02_instHetXfreqAll.txt" 
outputFile_subjHetFreqRetained <- "2_02_instHetXfreqRetained.txt"  
outputFile_SNPhhFreqAll <- "2_02_snpHHfreqAll.txt"
removedMaleHetX(plink, inputPrefix, hhSubjCutOff, outputPrefix, outputFile_subjHetFreqAll, outputFile_subjHetFreqRetained, outputFile_SNPhhFreqAll) 
```

3. Set all heterozygous alleles of SNPs of the chromosome 23 for males (i.e. when the SNP has the value one as the minor allele count) as missing. 
+ Output files: 2_03_setHeteroHaploMissing.#
```{r eval=FALSE} 
inputPrefix <- "2_02_removedInstHetX" 
outputPrefix <- "2_03_setHeteroHaploMissing" 
setHeteroHaploMissing(plink, inputPrefix, outputPrefix)
```
4. Remove SNPs with missingness >= 0.05 (before instance removal).
+ Output files: 2_04_removedSnpMissPre.#
```{r eval=FALSE} 
inputPrefix <- "2_03_setHeteroHaploMissing" 
snpMissCutOff <- 0.05  
outputPrefix <- "2_04_removedSnpMissPre" 
removedSnpMiss(plink, snpMissCutOff, inputPrefix, outputPrefix) 
```
5. Remove instances with missingness  >= 0.02.
+ Output files: 2_05_removedInstMiss.#
```{r eval=FALSE} 
inputPrefix <- "2_04_removedSnpMissPre" 
sampleMissCutOff <- 0.02
outputPrefix <- "2_05_removedInstMiss" 
removedInstMiss(plink, sampleMissCutOff, inputPrefix, outputPrefix)
```
6. Remove instances with great autosomal heterozygosity deviation, i.e. with |Fhet| >= 0.2
+ Output files: 2_06_removedInstFhet.#
```{r eval=FALSE} 
inputPrefix <- "2_05_removedInstMiss" 
Fhet <- 0.2  
outputPrefix <- "2_06_removedInstFhet" 
removedInstFhet(plink, Fhet, inputPrefix, outputPrefix)
```
7. Replace the paternal ID and maternal ID of instances (childs) by the value zero if the paternal ID and the maternal ID do not belong to any instance (parent) with the same family ID as the child.
+ Output files: 2_07_removedParentIdsMiss.#
```{r eval=FALSE} 
inputPrefix <- "2_06_removedInstFhet"  
outputPrefix <- "2_07_removedParentIdsMiss" 
removedParentIdsMiss(plink, inputPrefix, outputPrefix)
```
8. Remove SNPs with missingness >= 0.02 (after instance removal).
+ Output files: 2_08_removedSnpMissPost.#
```{r eval=FALSE} 
snpMissCutOff <- 0.02
inputPrefix <- "2_07_removedParentIdsMiss"  
outputPrefix <- "2_08_removedSnpMissPost" 
removedSnpMiss(plink, snpMissCutOff, inputPrefix, outputPrefix)
```
9. Remove SNPs with difference >= 0.02 of SNP missingness between cases and controls.
+ Output files: 2_09_removedSnpMissDiff.#
```{r eval=FALSE} 
inputPrefix <- "2_08_removedSnpMissPost"  
outputPrefix <- "2_09_removedSnpMissDiff" 
snpMissDifCutOff <- 0.02  
removedSnpMissDiff(plink, inputPrefix, snpMissDifCutOff, outputPrefix, caseControl) 
```
10. Remove chrX SNPs with missingness  >= 0.05 in females. (Optional, if no chrX data)
+ Output files: 2_10_removedSnpFemaleChrXmiss.#
```{r eval=FALSE} 
femaleChrXmissCutoff <- 0.05
inputPrefix <- "2_09_removedSnpMissDiff"  
outputPrefix <- "2_10_removedSnpFemaleChrXmiss" 
removedSnpFemaleChrXmiss(plink, femaleChrXmissCutoff, inputPrefix, outputPrefix)
```
11. Remove autosomal SNPs with Hardy-Weinberg equilibrium p < 10-6 in controls.
+ Primary output files: 2_11_removedSnpHweAutoCt.#
+ Output file with HWE p-value for the autosomal SNPs before removing, sorted ascending by the p-values: 2_11_snpHwePvalAutoCt.txt
+ Output file with the removed SNP names: 2_11_snpRemovedHweAutoCt.txt
```{r eval=FALSE} 
pval <- 0.000001
inputPrefix <- "2_10_removedSnpFemaleChrXmiss"  
outputFile_pVal <- "2_11_snpHwePvalAutoCt.txt" 
outputSNPfile <-  "2_11_snpRemovedHweAutoCt.txt" 
outputPrefix <- "2_11_removedSnpHweAutoCt" 

removedSnpHWEautoControl(plink, inputPrefix, pval, outputFile_pVal, outputSNPfile, outputPrefix)
```
12. Remove chrX SNPs with HWE p < 10-6 in female controls. (Optional, if no chrX data)
+ Primary output files: 2_12_removedSnpHweFemaleXct.#
+ Output file with HWE p-value for the female chrX SNPs before removing, sorted ascending by the p-values:2_12_snpHwePvalfemaleXct.txt
+ Output file with the removed SNP names:2_12_snpRemovedHweFemaleXct.txt
```{r eval=FALSE} 
pval <- 0.000001
inputPrefix <- "2_11_removedSnpHweAutoCt"   
outputFile_pVal <- "2_12_snpHwePvalfemaleXct.txt" 
outputSNPfile <- "2_12_snpRemovedHweFemaleXct.txt" 
outputPrefix <- "2_12_removedSnpHweFemaleXct" 
removedSnpFemaleChrXhweControl(plink, inputPrefix, pval, outputFile_pVal, outputSNPfile, outputPrefix)
```

13. Calculate the PCA (with plots) for 2_12_removedSnpHweFemaleXct.# and remove the outliers from that dataset (for the definition of the outliers see section 2.4.2).
+ Primary output files: 2_13_removedOutliers.#
+ Output file with the IDs of the instances and the values of their eigenvectors from the PCA after removal of instances: 2_13_eigenvalAfterQC.txt
+ Output file with the plot of the first two PCs from the PCA before removal of instances: 2_13_eigenvalAfterQC.png
+ Output file with the plot of the first two PCs from the PCA after removal of instances: 2_13_removedOutliers.png
+ Output file with the IDs of the removed instances and the values of their eigenvectors, sorted ascending by the PC values: 2_13_eigenval4outliers.txt
```{r eval=FALSE} 
## For the ethnic group info
setwd('..')
metaDataFile <- "1_01_metaData.txt"
system( paste0("scp ./1-conversion/", metaDataFile, " ./2-QC/") )
setwd("./2-QC/")
################################################ 
 
inputPrefix <- "2_12_removedSnpHweFemaleXct" ## the output from step 12
outputPC4subjFile <- "2_13_eigenvalAfterQC.txt"
outputPCplotFile <- "2_13_eigenvalAfterQC.png"
plotPCA4plink(gcta, inputPrefix, outputPC4subjFile, outputPCplotFile)
## remove outliers
inputPrefix <- "2_12_removedSnpHweFemaleXct"
cutoff <-  NULL 
cutoffSign <- 'greater' ## not used if cutoff==NULL


inputPC4subjFile <- "2_13_eigenvalAfterQC.txt"
outputPC4outlierFile <- "2_13_eigenval4outliers.txt"
outputPCplotFile <- "2_13_removedOutliers.png"
outputPrefix <- "2_13_removedOutliers" 

removeOutlierByPCs(plink, gcta, inputPrefix, cutoff, cutoffSign, inputPC4subjFile, outputPC4outlierFile, outputPCplotFile, outputPrefix)

## remove unwanted files
## remove meta file and metaDataFile+AA.txt
system( paste0("rm  ", metaDataFile) ) 
system( paste0("rm  *.log *.hh") )
## change dir 
setwd("..") 
```

 
  
## Alignment with the reference

All files named in this subsection are in the directory 3-lifting/.  

Input files:

* PLINK files after quality control and population outlier detection: 2_13_removedOutliers.#
* Imputation reference files (see section 2.4.2).

Processing steps:
1. If the genome build of already QC-ed is different from the genome build of the imputation reference files, then lift the data from the first genome build to the second. If the genome build is the same, then just copy the input files.
 
+ Output files: 3_1_liftedDataset.#

2. Remove SNPs for which the name has a different position (i.e. combination of base pair position and chromosome) in the imputation reference files.

+ Primary output files: 3_2_removedSnpDiffNamePos.#
+ Output file with the SNPs names for which a different position is contained in the imputation reference files: 3_2_snpDiffNamePos.txt

3. Remove SNPs for which the combination of base pair position and chromosome is not contained in the imputation reference files (ignoring the SNP name).
+ Primary output files: 3_3_removedSnpMissPos.#
+ Output file with the SNPs names for which the combination of base pair position and chromosome is not contained in the imputation reference files: 3_3_snpMissPos.txt

4. Remove SNPs from which the combination of base pair position and chromosome (ignoring the SNP name) has an allele which is not in the
imputation reference files for that combination of base pair position and chromosome.

+ Primary output files: 3_4_removedSnpDiffAlleles.#
+ Output file with the removed SNP names: 3_4_snpDiffAlleles.txt
+ Output file with the retained SNPs: 3_4_snpImpRefAlleles.txt
 

```{r eval=FALSE} 
system( paste0("cp ./2-QC/2_13_removedOutliers.bed ./3-lifting/3_1_liftedDataset.bed") )
system( paste0("cp ./2-QC/2_13_removedOutliers.fam ./3-lifting/3_1_liftedDataset.fam") )
system( paste0("cp ./2-QC/2_13_removedOutliers.bim ./3-lifting/3_1_liftedDataset.bim") )
setwd("./3-lifting/")
 
inputFile <- paste0(impRefDIR,'/', '*.legend.gz')  ## >> directories need to be changed 
referenceFile <- paste0(impRefDIR, 'bimImputeRef.txt')
prepareLegend2bim(inputFile, outputFile=referenceFile, ncore=25) ## take less than 1 minute
inputPrefix <- "3_1_liftedDataset" 
out2.snp <- "3_2_snpSameNameDiffPos"
out2 <- "3_2_removedSnpSameNameDiffPos"
  
# 3. Remove SNPs which bp and chr position are not contained in the imputation reference files.
out3 <- "3_3_removedSnpMissPos"
out3.snp <- "3_3_snpMissPos"
  
## 4. Remove SNPs which have an allele which is not in the imputation reference files for that SNP.
out4 <- "3_4_removedSnpDiffAlleles"
out4.snp <- "3_4_snpDiffAlleles"
out4.snpRetained <- "3_4_snpImpRefAlleles"
 
checkAlign2ref(plink, inputPrefix, referenceFile, out2, out2.snp, out3, out3.snp, out4, out4.snp, out4.snpRetained, nCore=25)
system( paste0("rm  *.log *.hh") ) 
setwd("..")

```  
 

## Imputation
All files named in this subsection are in the directory 4-imputation/.

Input files:

* PLINK genotyping data after QC and the alignment with the imputation reference files: ../3-lifting/3_4_removedSnpDiffAlleles.#
* Imputation reference files (see section 2.4.2).

Processing steps:

1. Remove monomorphic SNPs from the well aligned genotyping data.
+ Primary output files: 4_1_removedMonoSnp.#
+ Output file with the removed monomorphic SNPs: 4_1_snpMonoRemoved.txt
```{r eval=FALSE} 
inputPrefix4aligned2impRef <- "3_4_removedSnpDiffAlleles" ## will also be used in later steps;
outputPrefix <- "4_1_removedMonoSnp" 
outputMonoSNPfile <- "4_1_snpMonoRemoved.txt" # will be used in later steps.

## copy plink files from last step; 
system( paste0("cp ./3-lifting/", inputPrefix4aligned2impRef, ".bed  ./4-imputation/") )
system( paste0("cp ./3-lifting/", inputPrefix4aligned2impRef, ".fam  ./4-imputation/") )
system( paste0("cp ./3-lifting/", inputPrefix4aligned2impRef, ".bim  ./4-imputation/") )

## remove Monomorphic SNPs
setwd('4-imputation')
removedMonoSnp(plink, inputPrefix4aligned2impRef, outputPrefix, outputMonoSNPfile)
```

2. Use the imputation reference files to generate pre-phase haplotypes by SHAPEIT and then do the imputation by using IMPUTE2.
+ Output files: 4_2_imputedDataset.#

The following R functions are required to complete the pre-phasing and imputation processes.


```{r eval=FALSE} 
chrWiseSplit()
chunk4eachChr()
prePhasingByShapeit()
imputedByImpute2()
formatConvertGtool() 
mergeImputeData()
filterImputeData()
```

3. Remove imputed SNPs with (info < 0.6) where the value info comes from the files *.impute2_info from the imputation.
+ Primary output files: 4_3_removedSnpInfoPostImp.#
+ Output file with the removed SNP names: 4_3_snpRemovedInfoPostImp.txt
+ Output file with the info scores of all SNPs, which consists of two columns, separated by whitespaces, the first the SNPs and the second the info scores: 4_3_snpImputedInfoScore.txt  

```{r eval=FALSE} 
prefix4imputedFilterPlink <- "gwasImputedFiltered"
filteredImputedDatasetfn <- "4_3_removedSnpInfoPostImp" 
snpWithBadInfoFile <- "4_3_snpRemovedInfoPostImp.txt"
snpImputedInfoScoreFile <- "4_3_snpImputedInfoScore.txt"
 
system( paste0("scp ./", tmp4imputeDIR, "/6-finalResults/", prefix4imputedFilterPlink, ".bed ", filteredImputedDatasetfn, ".bed") )
system( paste0("scp ./", tmp4imputeDIR, "/6-finalResults/", prefix4imputedFilterPlink, ".bim ", filteredImputedDatasetfn, ".bim") )
system( paste0("scp ./", tmp4imputeDIR, "/6-finalResults/", prefix4imputedFilterPlink, ".fam ", filteredImputedDatasetfn, ".fam") )
system( paste0("scp ./", tmp4imputeDIR, "/6-finalResults/", impute2infoFile, " ", snpImputedInfoScoreFile) )
system( paste0("scp ./", tmp4imputeDIR, "/6-finalResults/", badImputeSNPfile, " ", snpWithBadInfoFile) ) 
```

4. Remove all SNPs (if any) which have the same position as a SNP in 4_1_snpMonoRemoved.txt has in lifted instance data.
+ Output files: 4_4_removedMonoSnpAfter.#

```{r eval=FALSE} 
filteredImputedDatasetfn <- "4_3_removedSnpInfoPostImp" 
removedMonoSnpAfter <- "4_4_removedMonoSnpAfter"
## extract PLINK files contain only monomorphic SNPs from the original aligned (lifted and QC-ed) data set.
	system( paste0(plink, " --bfile ", inputPrefix4aligned2impRef, " --extract ", outputMonoSNPfile, " --make-bed --out ", inputPrefix4aligned2impRef, "Tmp") ) 
	system( paste0(perl4snpsWithSamePos, " ", filteredImputedDatasetfn, ".bim ", inputPrefix4aligned2impRef, "Tmp", ".bim > tmp.txt" ))
	bim1 <- read.table(paste0(inputPrefix4aligned2impRef, "Tmp.bim"), stringsAsFactors=F)
	system(paste0("awk '{print $1, $2, $4}' ", filteredImputedDatasetfn, ".bim > tmpFilterImp.txt"))
	bim2 <- read.table('tmpFilterImp.txt', stringsAsFactors=F) 
	colnames(bim1) <- c('chr', 'rsID', 'gd', 'pos', 'a0', 'a1') 
	colnames(bim2) <- c('chr', 'rsID', 'pos')
	outputFile <- 'tmp.txt'
	snpSharedPos(inputFile1=bim1, inputFile2=bim2, outputFile, nCore=25) 
	system( paste0(plink, " --bfile ", filteredImputedDatasetfn, " --exclude tmp.txt --make-bed --out ", removedMonoSnpAfter) )
	system('rm tmpFilterImp.txt tmp.txt')
```

5. Add previous identified monomorphic SNPs (if any) in 4_1_snpMonoRemoved.txt with their values from the lifted instance data.
+ Output files: 4_5_addedMonoSnpAfter.# 

```{r eval=FALSE} 
addedMonoSnpAfter <- "4_5_addedMonoSnpAfter" 
## merge both datasets
system( paste0(plink, " --bfile ", removedMonoSnpAfter, " --bmerge ", inputPrefix4aligned2impRef, ".bed ", inputPrefix4aligned2impRef, ".bim", inputPrefix4aligned2impRef, ".fam --make-bed --out ", addedMonoSnpAfter) )}    
```

6. Remove SNPs which have a non missing value for less then 20 instances.
+ Primary output files: 4_6_removedSnpMissPostImp.#
+ Output file with the removed SNP names: 4_6_snpRemovedMissPostImp.txt

```{r eval=FALSE} 
inputPrefix <- addedMonoSnpAfter  
missCutoff <- 20
outputPrefix <- "4_6_removedSnpMissPostImp"
snpWithManyMissSNPfile <- "4_6_snpRemovedMissPostImp.txt"
removedSnpMissPostImp(plink, inputPrefix, missCutoff, snpWithManyMissSNPfile, outputPrefix)
setwd("..")  
```

## Reduction and expansion

All files named in this subsection are in the directory 5-reductAndExpand/.

Input files:

* The imputed dataset:../4-imputation/4_6_removedSnpMissPostImp.#
* The SNPs before imputation:../3-lifting/3_4_snpImpRefAlleles.txt
* The file with the SNPs with different alleles:../3-lifting/3_4_snpDiffAlleles.txt
* The SNPs with missing positions: ../3-lifting/3_3_snpMissPos.txt
* The SNPs with different positions: ../3-lifting/3_2_snpDiffNamePos.txt
* The dataset before removing SNPs for imputation: ../3-lifting/3_1_liftedDataset.#

Processing steps:


1. Firt of all, copy all the input files into the directory ./5-reductAndExpand/. Then do the reduction of the imputed dataset to the SNPs before imputation.
+ Output files: 5_1_reducedToSpecific.#

```{r eval=FALSE} 
setwd("5-reductAndExpand/")

inputPrefix <- "4_6_removedSnpMissPostImp"
reducedToSpecificfn <- "5_1_reducedToSpecific"
# 1. Reduce the imputed dataset to the SNPs before imputation. 
system(paste0(plink, " --bfile ", inputPrefix, " --extract 3_4_snpImpRefAlleles.txt --make-bed --out ", reducedToSpecificfn) ) 
```  

2. Add the SNPs (if any) with different alleles from the dataset before removing SNPs.
+ Output files: 5_2_extSpecificDiffAllele.#

```{r eval=FALSE} 
inputOriginalQCed <- "3_1_liftedDataset"
reducedToSpecificfn <- "5_1_reducedToSpecific"
extSpecificDiffAllelefn <- "5_2_extSpecificDiffAllele"
system(paste0(plink, " --bfile ", inputOriginalQCed, " --extract 3_4_snpDiffAlleles.txt --make-bed --out tmp") ) 
system(paste0(plink, " --bfile ", reducedToSpecificfn, " --bmerge  tmp.bed tmp.bim tmp.fam --make-bed --out ", extSpecificDiffAllelefn) ) 
```  

3. Add the SNPs (if any) with missing positions from the dataset before removing SNPs.
+ Output files: 5_3_extSpecificMissPos.#


```{r eval=FALSE} 
inputOriginalQCed <- "3_1_liftedDataset"
extSpecificDiffAllelefn <- "5_2_extSpecificDiffAllele"
extSpecificMissPosfn <- "5_3_extSpecificMissPos"
system(paste0(plink, " --bfile ", inputOriginalQCed, " --extract 3_3_snpMissPos.txt --make-bed --out tmp") ) 
system(paste0(plink, " --bfile ", extSpecificDiffAllelefn, " --bmerge  tmp.bed tmp.bim tmp.fam --make-bed --out ", extSpecificMissPosfn) ) 
```   

4. Add the SNPs (if any) with different positions from the dataset before removing SNPs.
+ Output files: 5_4_extSpecificDiffPos.#

```{r eval=FALSE} 
system(paste0(plink, " --bfile ", inputOriginalQCed, " --extract 3_2_snpDiffNamePos.txt --make-bed --out tmp") ) 
system(paste0(plink, " --bfile ", extSpecificMissPosfn, " --bmerge  tmp.bed tmp.bim tmp.fam --make-bed --out ", extSpecificDiffPosfn) ) 
```  

## Final results
Copy the results of interest to the directory ./6-finalResults.

```{r eval=FALSE} 
## imputed dataset
system(paste0("scp ./1-conversion/1_01_metaData.txt ./6-finalResults/metaData.txt " ))
 
## go to the directory/ dataset name 
system(paste0("scp ./4-imputation/4_6_removedSnpMissPostImp.* ./6-finalResults/"))  
system(paste0("scp ./5-reductAndExpand/5_4_extSpecificDiffPos.* ./6-finalResults/"))

setwd("./6-finalResults/")
renamePlinkBFile(inputPrefix="4_6_removedSnpMissPostImp.", 
				         outputPrefix="imputedSnpsDataset", action="move")

renamePlinkBFile(inputPrefix="5_4_extSpecificDiffPos.", 
				         outputPrefix="specificSnpsDataset", action="move")
```  


# Extending pipelines

## Integrate with Genipe
### Installation
To set up Genipe, please refer to Genipe's [installation](http://pgxcentre.github.io/genipe/installation.html#id3) page.

### Additional configuration files 
* Imputation reference panels

The imputation reference can be downloaded directly from IMPUTE2's reference page: [1000 Genome phase 3](https://mathgen.stats.ox.ac.uk/impute/1000GP_Phase3.html) or [Genipe's page](http://pgxcentre.github.io/genipe/tutorials/tutorial_genipe.html#data-in-more-details).

* The human reference files

This reference genome is used for the strand check, you can download from [Genipe's page](http://pgxcentre.github.io/genipe/tutorials/tutorial_genipe.html#data-in-more-details).


### Imputation with Genipe

1. Prepare additional configuration files.
```{r eval=FALSE} 
## example
impRefDIR4genipe <- "../1000G_Phase3_2014/"
fastaFile <- "../hg19/hg19.fasta"
```  

2. Imputing genotypes using Genipe.
```{r eval=FALSE} 
## Impute genotypes using Genipe
# chrs ="autosomes"
# chrs =23
chrs =22
inputPrefix <- "3_4_removedSnpDiffAlleles"
thread4impute2 <- 20 ## tune by yourself
thread4shapeit <- 30
segmentSize <- 3000000
imputedByGenipe(chrs, impRefDIR4genipe, inputPrefix, shapeit, impute2, plink, fastaFile, segmentSize, thread4impute2, thread4shapeit) 
```

3. Merge chunk-specific region using Genipe.
```{r eval=FALSE} 
## merge chunked genomic imputed results
## example
chr <- 2 
inputImpute2 <- 'chr2.33000001_36000000.impute2'
probability <- 0.9
completionRate <- 0.98
# info <- 0.6
outputPrefix <- paste0('imputedChr', chr)
mergeByGenipe(inputImpute2, chr, probability, completionRate, info, outputPrefix)
``` 

4. Extract imputed results chromosome-wise by Genipe.
```{r eval=FALSE}  
## extract imputed markers using Genipe 
chr <- 3
inputImpute2 <- paste0('chr', chr,'.imputed.impute2')
inputMAP <- paste0('chr', chr,'.imputed.map')
format <- 'bed'
prob <- 0.9
outputPrefix <- paste0('imputedChr', chr)  
extractByGenipe(inputImpute2, inputMAP, outputPrefix, format, prob)
```     
 

# Trouble-shooting 
If you have any trouble or comment ? --> Contact: junfang.chen@zi-mannheim.de





